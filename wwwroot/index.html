<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyDU Market Browser</title>
    <style>
        /* Global Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            min-height: 100vh;
        }

        /* Navigation Header */
        .nav-header {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 10px 0;
            margin-bottom: 10px;
        }

        .nav-header .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-header .nav-brand {
            color: #fff;
            font-size: 1.2rem;
            font-weight: 600;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .nav-header .nav-brand:hover {
            color: #4a90e2;
        }

        .nav-header .nav-links {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .nav-header .nav-link {
            color: #ccc;
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.3s ease;
        }

        .nav-header .nav-link:hover {
            color: #fff;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            color: #1e3c72;
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header .subtitle {
            color: #666;
            font-size: 1.1rem;
        }

        /* Status Bar */
        .status-bar {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #28a745;
        }

        .status-indicator.warning {
            background: #ffc107;
        }

        .status-indicator.error {
            background: #dc3545;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            min-width: 120px;
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: rgba(30, 60, 114, 0.1);
        }

        .nav-tab.active {
            background: #1e3c72;
            color: white;
        }

        /* Content Panels */
        .content-panel {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .content-panel.active {
            display: block;
        }

        /* Search and Filters */
        .search-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .search-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .search-group {
            flex: 1;
            min-width: 200px;
        }

        .search-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .search-group input,
        .search-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .search-group input:focus,
        .search-group select:focus {
            outline: none;
            border-color: #1e3c72;
        }

        .search-actions {
            display: flex;
            gap: 10px;
            align-items: end;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #1e3c72;
            color: white;
        }

        .btn-primary:hover {
            background: #2a5298;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .data-table th {
            background: #1e3c72;
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        .data-table th:hover {
            background: #2a5298;
        }

        .data-table th.sortable::after {
            content: '‚Üï';
            position: absolute;
            right: 8px;
            opacity: 0.5;
        }

        .data-table th.sort-asc::after {
            content: '‚Üë';
            opacity: 1;
        }

        .data-table th.sort-desc::after {
            content: '‚Üì';
            opacity: 1;
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .data-table tr:nth-child(even) {
            background: #fafafa;
        }

        .data-table tr:nth-child(even):hover {
            background: #f0f0f0;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e3c72;
        }

        /* Loading and Error States */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1e3c72;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #f5c6cb;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* Profit Content Tabs */
        .profit-content {
            display: none;
        }

        .profit-content.active {
            display: block;
        }

        /* Route Cards */
        .route-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #6f42c1;
        }

        .route-summary {
            background: linear-gradient(135deg, #6f42c1, #e83e8c);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .route-markets {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .route-market {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 4px solid #1e3c72;
        }

        .route-arrow {
            color: #1e3c72;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .opportunity-card {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #28a745;
            margin-bottom: 10px;
        }

        /* Utility Classes */
        .text-center {
            text-align: center;
        }

        .text-success {
            color: #28a745;
        }

        .text-danger {
            color: #dc3545;
        }

        .text-muted {
            color: #6c757d;
        }

        .font-weight-bold {
            font-weight: 700;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .pagination-info {
            color: #666;
            font-size: 14px;
        }

        .pagination-controls {
            display: flex;
            gap: 5px;
        }

        .page-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .page-btn:hover:not(:disabled) {
            background: #1e3c72;
            color: white;
        }

        .page-btn.active {
            background: #1e3c72;
            color: white;
            border-color: #1e3c72;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Notification animations */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Footer */
        .footer {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            margin-top: 50px;
            padding: 40px 0 20px 0;
        }

        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
        }

        .footer-section h4 {
            color: #fff;
            margin-bottom: 15px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .footer-section p {
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.5;
        }

        .footer-section ul {
            list-style: none;
            padding: 0;
        }

        .footer-section ul li {
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.9);
            position: relative;
            padding-left: 15px;
        }

        .footer-section ul li::before {
            content: '‚Ä¢';
            color: #4a90e2;
            position: absolute;
            left: 0;
        }

        .company-link {
            color: #4a90e2;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        .company-link:hover {
            color: #fff;
            text-decoration: underline;
        }

        .footer-tagline {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            font-style: italic;
        }

        .footer-bottom {
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 30px;
            padding-top: 20px;
            text-align: center;
        }

        .footer-bottom p {
            margin: 0;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
        }

        /* Responsive footer */
        @media (max-width: 768px) {
            .footer-content {
                grid-template-columns: 1fr;
                text-align: center;
            }
        }
    </style>
</head>

<body>
    <!-- Navigation Header -->
    <div class="nav-header">
        <div class="nav-container">
            <a href="https://du.north-industries.com/" class="nav-brand">‚Üê Back to North Industries</a>
            <div class="nav-links">
                <span class="nav-link">Market Browser</span>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>MyDU Market Browser</h1>
            <p class="subtitle">Advanced market analysis and trading opportunities</p>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-item">
                <div class="status-indicator" id="system-status"></div>
                <span id="system-status-text">Checking system status...</span>
            </div>
            <div class="status-item">
                <span id="data-age">Data age: Unknown</span>
            </div>
            <div class="status-item">
                <span id="market-count">Markets: 0</span>
            </div>
            <div class="status-item">
                <span id="order-count">Orders: 0</span>
            </div>

        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('markets')">Markets</button>
            <button class="nav-tab" onclick="showTab('orders')">Orders</button>
            <button class="nav-tab" onclick="showTab('profits')">Profit Opportunities</button>
            <button class="nav-tab" onclick="showTab('planets')">Planets</button>
            <button class="nav-tab" onclick="showTab('statistics')">Statistics</button>
        </div>

        <!-- Markets Panel -->
        <div id="markets-panel" class="content-panel active">
            <!-- Base Market Selection -->
            <div class="search-section" style="background: #e8f4fd; border: 1px solid #1e3c72;">
                <h4 style="margin: 0 0 15px 0; color: #1e3c72;">Base Market Selection</h4>
                <div class="search-row">
                    <div class="search-group" style="flex: 2;">
                        <label for="base-market-info">Current Base Market</label>
                        <div id="base-market-info"
                            style="padding: 8px; background: white; border-radius: 5px; border: 1px solid #ddd;">
                            <span id="base-market-text">No base market selected</span>
                        </div>
                    </div>
                    <div class="search-actions">
                        <button class="btn btn-secondary" onclick="clearBaseMarket()" id="clear-base-btn" disabled>Clear
                            Base Market</button>
                    </div>
                </div>
                <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                    üí° Select a market from the table below to set it as your base market for distance calculations
                </div>
            </div>

            <div class="search-section">
                <div class="search-row">
                    <div class="search-group">
                        <label for="market-search">Market Name</label>
                        <input type="text" id="market-search" placeholder="Search markets...">
                    </div>
                    <div class="search-group">
                        <label for="market-planet">Planet</label>
                        <select id="market-planet">
                            <option value="">All Planets</option>
                        </select>
                    </div>
                    <div class="search-actions">
                        <button class="btn btn-primary" onclick="searchMarkets()">Search</button>
                        <button class="btn btn-secondary" onclick="clearMarketFilters()">Clear</button>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortMarkets('name')">Market Name</th>
                            <th class="sortable" onclick="sortMarkets('planetName')">Planet</th>
                            <th class="sortable" onclick="sortMarkets('orderCount')">Orders</th>
                            <th class="sortable" onclick="sortMarkets('distance')">Distance from Origin</th>
                            <th class="sortable" onclick="sortMarkets('baseDistance')">Distance from Base</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="markets-table-body">
                        <tr>
                            <td colspan="6" class="loading">Loading markets...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="pagination" id="markets-pagination"></div>
        </div>

        <!-- Orders Panel -->
        <div id="orders-panel" class="content-panel">
            <div class="search-section">
                <div class="search-row">
                    <div class="search-group">
                        <label for="order-item">Item Name</label>
                        <input type="text" id="order-item" placeholder="Search items...">
                    </div>
                    <div class="search-group">
                        <label for="order-market">Market</label>
                        <select id="order-market">
                            <option value="">All Markets</option>
                        </select>
                    </div>
                    <div class="search-group">
                        <label for="order-type">Order Type</label>
                        <select id="order-type">
                            <option value="">All Orders</option>
                            <option value="buy">Buy Orders</option>
                            <option value="sell">Sell Orders</option>
                        </select>
                    </div>
                    <div class="search-actions">
                        <button class="btn btn-primary" onclick="searchOrders()">Search</button>
                        <button class="btn btn-secondary" onclick="clearOrderFilters()">Clear</button>
                    </div>
                </div>
            </div>

            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortOrders('itemName')">Item</th>
                            <th class="sortable" onclick="sortOrders('orderType')">Type</th>
                            <th class="sortable" onclick="sortOrders('quantity')">Quantity</th>
                            <th class="sortable" onclick="sortOrders('unitPrice')">Price</th>
                            <th class="sortable" onclick="sortOrders('marketName')">Market</th>
                            <th class="sortable" onclick="sortOrders('playerName')">Player</th>
                        </tr>
                    </thead>
                    <tbody id="orders-table-body">
                        <tr>
                            <td colspan="6" class="loading">Loading orders...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="pagination" id="orders-pagination"></div>
        </div>

        <!-- Profit Opportunities Panel -->
        <div id="profits-panel" class="content-panel">
            <!-- Explanation Section -->
            <div
                style="background: #e8f4fd; border: 1px solid #1e3c72; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                <h4 style="margin: 0 0 10px 0; color: #1e3c72;">üí° How Profit Opportunities Work</h4>
                <p style="margin: 0; color: #666; font-size: 0.9em;">
                    These opportunities show where you can <strong>buy low and sell high</strong>.
                    Buy the item from the "Buy From" market (low price), then sell it to the "Sell To" market (high
                    price) for profit.
                    The distance shown is between the two markets.
                </p>
            </div>

            <!-- Route Planning Section -->
            <div class="search-section" style="background: #f0f8ff; border: 1px solid #4a90e2;">
                <h4 style="margin: 0 0 15px 0; color: #4a90e2;">üó∫Ô∏è Smart Route Planning</h4>
                <div class="search-row">
                    <div class="search-group">
                        <label for="destination-market">Destination Market (Optional)</label>
                        <select id="destination-market">
                            <option value="">Any destination market</option>
                        </select>
                    </div>
                    <div class="search-group">
                        <label for="max-distance-base">Max Distance from Base (SU)</label>
                        <input type="number" id="max-distance-base" placeholder="No limit" step="1" min="1">
                    </div>
                    <div class="search-group">
                        <label for="max-distance-dest">Max Distance to Destination (SU)</label>
                        <input type="number" id="max-distance-dest" placeholder="No limit" step="1" min="1">
                    </div>
                    <div class="search-group">
                        <label for="route-optimization">Analysis Mode</label>
                        <select id="route-optimization">
                            <option value="false">All Market Opportunities</option>
                            <option value="true">Base Market Focused</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                    <strong>Base Market Focused:</strong> Shows opportunities based on items available at your selected
                    base market<br>
                    <strong>Destination Market:</strong> Further filters to items that both base and destination markets
                    trade<br>
                    <strong>Route Generation:</strong> Creates multi-stop routes between base and destination for
                    maximum profit
                </div>
            </div>

            <div class="search-section">
                <div class="search-row">
                    <div class="search-group">
                        <label for="profit-item">Item Name</label>
                        <input type="text" id="profit-item" placeholder="Search items...">
                    </div>
                    <div class="search-group">
                        <label for="profit-min-margin">Min Profit Margin (%)</label>
                        <input type="number" id="profit-min-margin" placeholder="0" step="0.1">
                    </div>
                    <div class="search-actions">
                        <button class="btn btn-primary" onclick="searchProfits()">Search Opportunities</button>
                        <button class="btn btn-success" onclick="generateOptimizedRoutes()">Generate Routes</button>
                        <button class="btn btn-secondary" onclick="clearProfitFilters()">Clear</button>
                    </div>
                </div>
            </div>

            <!-- Tab Navigation for Opportunities vs Routes -->
            <div class="nav-tabs" style="margin-bottom: 20px;">
                <button class="nav-tab active" onclick="showProfitTab('opportunities')">Profit Opportunities</button>
                <button class="nav-tab" onclick="showProfitTab('routes')">Optimized Routes</button>
            </div>

            <!-- Opportunities Content -->
            <div id="opportunities-content" class="profit-content active">
                <div id="profits-container">
                    <div class="loading">Loading profit opportunities...</div>
                </div>
                <div class="pagination" id="profits-pagination"></div>
            </div>

            <!-- Routes Content -->
            <div id="routes-content" class="profit-content" style="display: none;">
                <div id="routes-container">
                    <div class="empty-state">Click "Generate Routes" to create optimized trading routes</div>
                </div>
            </div>
        </div>

        <!-- Planets Panel -->
        <div id="planets-panel" class="content-panel">
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortPlanets('name')">Planet Name</th>
                            <th class="sortable" onclick="sortPlanets('marketCount')">Markets</th>
                            <th class="sortable" onclick="sortPlanets('distance')">Distance from Origin</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="planets-table-body">
                        <tr>
                            <td colspan="4" class="loading">Loading planets...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Statistics Panel -->
        <div id="statistics-panel" class="content-panel">
            <div id="statistics-container">
                <div class="loading">Loading statistics...</div>
            </div>
        </div>
    </div>

    <script>
        // API URL helper for reverse proxy scenarios
        function getApiUrl(endpoint) {
            // Get the base path from the current URL
            const pathSegments = window.location.pathname.split('/').filter(segment => segment);

            // If we're running under a path base (like /market), use it
            if (pathSegments.length > 0 && pathSegments[0] !== 'api') {
                const basePath = '/' + pathSegments[0];
                const fullUrl = `${basePath}/api/market${endpoint}`;
                console.log(`API URL: ${endpoint} -> ${fullUrl} (base: ${basePath})`);
                return fullUrl;
            }

            // Default to root-level API
            const fullUrl = `/api/market${endpoint}`;
            console.log(`API URL: ${endpoint} -> ${fullUrl} (no base path)`);
            return fullUrl;
        }

        // Global state
        let currentTab = 'markets';
        let currentData = {
            markets: { data: [], page: 1, totalPages: 1, sortBy: 'name', sortOrder: 'asc' },
            orders: { data: [], page: 1, totalPages: 1, sortBy: 'unitPrice', sortOrder: 'asc' },
            profits: { data: [], page: 1, totalPages: 1, sortBy: 'totalProfit', sortOrder: 'desc' },
            planets: { data: [], sortBy: 'name', sortOrder: 'asc' }
        };
        let systemStatus = null;

        // Detect base path for API calls
        const basePath = window.location.pathname.replace(/\/+$/, '').replace(/\/[^\/]*$/, '') || '';
        const apiBase = basePath ? `${basePath}/api/market` : '/api/market';

        console.log(`Detected base path: '${basePath}', API base: '${apiBase}'`);

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Frontend initialized, loading data...');
            loadSystemStatus();
            loadBaseMarket();
            loadPlanets();
            loadMarkets();
        });

        // Tab Management
        function showTab(tabName) {
            // Update navigation
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');

            // Update content panels
            document.querySelectorAll('.content-panel').forEach(panel => panel.classList.remove('active'));
            document.getElementById(`${tabName}-panel`).classList.add('active');

            currentTab = tabName;

            // Load data for the tab if not already loaded
            switch (tabName) {
                case 'markets':
                    if (currentData.markets.data.length === 0) loadMarkets();
                    break;
                case 'orders':
                    if (currentData.orders.data.length === 0) loadOrders();
                    // Ensure market dropdown is populated (but preserve current selection)
                    const currentMarketSelection = document.getElementById('order-market')?.value;
                    populateMarketDropdowns().then(() => {
                        if (currentMarketSelection) {
                            const marketSelect = document.getElementById('order-market');
                            if (marketSelect) {
                                marketSelect.value = currentMarketSelection;
                            }
                        }
                    });
                    break;
                case 'profits':
                    if (currentData.profits.data.length === 0) loadProfits();
                    // Ensure destination dropdown is populated
                    updateDestinationMarketDropdown();
                    break;
                case 'planets':
                    if (currentData.planets.data.length === 0) loadPlanets();
                    break;
                case 'statistics':
                    loadStatistics();
                    break;
            }
        }

        // System Status Management
        async function loadSystemStatus() {
            try {
                console.log('Loading system status...');
                const response = await fetch(getApiUrl('/status'));
                console.log('Status response:', response.status);
                systemStatus = await response.json();
                console.log('System status data:', systemStatus);

                updateStatusBar();
            } catch (error) {
                console.error('Error loading system status:', error);
                updateStatusBar(true);
            }
        }

        function updateStatusBar(hasError = false) {
            const statusIndicator = document.getElementById('system-status');
            const statusText = document.getElementById('system-status-text');
            const dataAge = document.getElementById('data-age');
            const marketCount = document.getElementById('market-count');
            const orderCount = document.getElementById('order-count');

            if (hasError || !systemStatus) {
                statusIndicator.className = 'status-indicator error';
                statusText.textContent = 'System Error';
                dataAge.textContent = 'Data age: Unknown';
                marketCount.textContent = 'Markets: Unknown';
                orderCount.textContent = 'Orders: Unknown';
                return;
            }

            // Update status indicator
            if (systemStatus.isHealthy) {
                statusIndicator.className = 'status-indicator';
            } else if (systemStatus.warnings && systemStatus.warnings.length > 0) {
                statusIndicator.className = 'status-indicator warning';
            } else {
                statusIndicator.className = 'status-indicator error';
            }

            // Update status text
            statusText.textContent = systemStatus.status || 'Unknown';

            // Update data age
            if (systemStatus.dataAge) {
                const ageStr = systemStatus.dataAge;
                const match = ageStr.match(/(\d+):(\d+):(\d+)/);
                if (match) {
                    const hours = parseInt(match[1]);
                    const minutes = parseInt(match[2]);
                    const totalMinutes = hours * 60 + minutes;
                    dataAge.textContent = `Data age: ${totalMinutes}m`;
                } else {
                    dataAge.textContent = `Data age: ${ageStr}`;
                }
            }

            // Update counts
            marketCount.textContent = `Markets: ${systemStatus.marketCount || 0}`;
            orderCount.textContent = `Orders: ${systemStatus.orderCount || 0}`;
        }



        // Base Market Management
        let currentBaseMarket = null;

        async function loadBaseMarket() {
            try {
                const response = await fetch(getApiUrl('/base-market'));
                const data = await response.json();

                currentBaseMarket = data.baseMarket;
                updateBaseMarketDisplay();
            } catch (error) {
                console.error('Error loading base market:', error);
            }
        }

        function updateBaseMarketDisplay() {
            const baseMarketText = document.getElementById('base-market-text');
            const clearBtn = document.getElementById('clear-base-btn');

            if (currentBaseMarket) {
                baseMarketText.innerHTML = `<strong>${currentBaseMarket.name}</strong> on <em>${currentBaseMarket.planetName}</em>`;
                baseMarketText.style.color = '#1e3c72';
                clearBtn.disabled = false;
            } else {
                baseMarketText.textContent = 'No base market selected';
                baseMarketText.style.color = '#666';
                clearBtn.disabled = true;
            }
        }

        async function setBaseMarket(marketId, marketName, planetName) {
            try {
                const response = await fetch(getApiUrl(`/base-market/${marketId}`), {
                    method: 'POST'
                });

                if (response.ok) {
                    const data = await response.json();
                    currentBaseMarket = data.baseMarket;
                    updateBaseMarketDisplay();

                    // Reload markets to show updated distances
                    await loadMarkets(currentData.markets.page);

                    showNotification(`Base market set to ${marketName} on ${planetName}`, 'success');
                } else {
                    throw new Error('Failed to set base market');
                }
            } catch (error) {
                console.error('Error setting base market:', error);
                showNotification('Error setting base market', 'error');
            }
        }

        async function clearBaseMarket() {
            try {
                const response = await fetch(getApiUrl('/base-market'), {
                    method: 'DELETE'
                });

                if (response.ok) {
                    currentBaseMarket = null;
                    updateBaseMarketDisplay();

                    // Reload markets to show updated distances
                    await loadMarkets(currentData.markets.page);

                    showNotification('Base market cleared', 'success');
                } else {
                    throw new Error('Failed to clear base market');
                }
            } catch (error) {
                console.error('Error clearing base market:', error);
                showNotification('Error clearing base market', 'error');
            }
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                animation: slideIn 0.3s ease;
                ${type === 'success' ? 'background: #28a745;' : ''}
                ${type === 'error' ? 'background: #dc3545;' : ''}
                ${type === 'info' ? 'background: #17a2b8;' : ''}
            `;

            document.body.appendChild(notification);

            // Remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Markets Management
        async function loadMarkets(page = 1) {
            const tableBody = document.getElementById('markets-table-body');
            tableBody.innerHTML = '<tr><td colspan="5" class="loading">Loading markets...</td></tr>';

            try {
                const params = new URLSearchParams({
                    page: page,
                    pageSize: 20,
                    sortBy: currentData.markets.sortBy,
                    sortOrder: currentData.markets.sortOrder
                });

                // Add filters
                const marketSearch = document.getElementById('market-search')?.value;
                const planetFilter = document.getElementById('market-planet')?.value;

                if (marketSearch) params.append('marketName', marketSearch);
                if (planetFilter) params.append('planetName', planetFilter);

                const response = await fetch(getApiUrl(`/markets?${params}`));
                const result = await response.json();

                if (response.ok && result.data && Array.isArray(result.data)) {
                    currentData.markets = {
                        data: result.data,
                        page: result.page,
                        totalPages: result.totalPages,
                        sortBy: currentData.markets.sortBy,
                        sortOrder: currentData.markets.sortOrder
                    };
                    renderMarketsTable();
                    renderPagination('markets', result);

                    // Update market dropdowns
                    await populateMarketDropdowns();
                    await updateDestinationMarketDropdown();
                } else {
                    console.error('Markets API response:', result);
                    tableBody.innerHTML = `<tr><td colspan="5" class="error">Error loading markets</td></tr>`;
                }
            } catch (error) {
                console.error('Error loading markets:', error);
                tableBody.innerHTML = '<tr><td colspan="5" class="error">Network error loading markets</td></tr>';
            }
        }

        async function updateDestinationMarketDropdown() {
            const destinationSelect = document.getElementById('destination-market');
            if (!destinationSelect) return;

            try {
                // Get all markets with proper planet data (same as markets tab)
                const response = await fetch(getApiUrl('/markets?pageSize=1000'));
                const result = await response.json();

                if (response.ok && result.data && Array.isArray(result.data)) {
                    const currentValue = destinationSelect.value;
                    destinationSelect.innerHTML = '<option value="">No destination (any market)</option>' +
                        result.data.map(market =>
                            `<option value="${market.marketId}" ${market.marketId == currentValue ? 'selected' : ''}>
                                ${escapeHtml(market.name)} (${escapeHtml(market.planetName)}) - ${market.distanceFromOriginFormatted || 'Unknown distance'}
                            </option>`
                        ).join('');
                }
            } catch (error) {
                console.error('Error loading destination markets:', error);
            }
        }

        function renderMarketsTable() {
            const tableBody = document.getElementById('markets-table-body');

            if (currentData.markets.data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="empty-state">No markets found</td></tr>';
                return;
            }

            tableBody.innerHTML = currentData.markets.data.map(market => {
                const isBaseMarket = currentBaseMarket && currentBaseMarket.marketId === market.marketId;
                const baseDistanceText = market.distanceFromBaseFormatted || (isBaseMarket ? 'Base Market' : '-');

                return `
                <tr ${isBaseMarket ? 'style="background-color: #e8f4fd; border-left: 4px solid #1e3c72;"' : ''}>
                    <td>
                        <strong>${escapeHtml(market.name)}</strong>
                        ${isBaseMarket ? '<span style="color: #1e3c72; font-size: 0.8em; margin-left: 8px;">üìç BASE</span>' : ''}
                    </td>
                    <td>${escapeHtml(market.planetName)}</td>
                    <td>${market.orderCount || 0}</td>
                    <td>${market.distanceFromOriginFormatted || formatDistance(market.distanceFromOrigin)}</td>
                    <td style="color: ${isBaseMarket ? '#1e3c72' : 'inherit'}; font-weight: ${isBaseMarket ? 'bold' : 'normal'};">
                        ${baseDistanceText}
                    </td>
                    <td>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                            <button class="btn btn-sm btn-primary" onclick="viewMarketOrders('${escapeHtml(market.name)}')">
                                View Orders
                            </button>
                            ${!isBaseMarket ? `
                                <button class="btn btn-sm btn-secondary" onclick="setBaseMarket(${market.marketId}, '${escapeHtml(market.name)}', '${escapeHtml(market.planetName)}')" title="Set as base market for distance calculations">
                                    Set as Base
                                </button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `}).join('');
        }

        function sortMarkets(column) {
            if (currentData.markets.sortBy === column) {
                currentData.markets.sortOrder = currentData.markets.sortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                currentData.markets.sortBy = column;
                currentData.markets.sortOrder = 'asc';
            }

            updateSortHeaders('markets', column, currentData.markets.sortOrder);
            loadMarkets(currentData.markets.page);
        }

        function searchMarkets() {
            loadMarkets(1);
        }

        function clearMarketFilters() {
            document.getElementById('market-search').value = '';
            document.getElementById('market-planet').value = '';
            searchMarkets();
        }

        function viewMarketOrders(marketName) {
            showTab('orders');

            // Set the market filter after ensuring dropdown is populated
            setTimeout(async () => {
                // Make sure dropdown is populated first
                await populateMarketDropdowns();

                // Then set the value
                const marketSelect = document.getElementById('order-market');
                if (marketSelect) {
                    marketSelect.value = marketName;
                }

                // Clear other filters and search
                document.getElementById('order-item').value = '';
                document.getElementById('order-type').value = '';
                searchOrders();
            }, 100);
        }

        // Orders Management
        async function loadOrders(page = 1) {
            const tableBody = document.getElementById('orders-table-body');
            tableBody.innerHTML = '<tr><td colspan="6" class="loading">Loading orders...</td></tr>';

            try {
                const params = new URLSearchParams({
                    page: page,
                    pageSize: 50,
                    sortBy: currentData.orders.sortBy,
                    sortOrder: currentData.orders.sortOrder
                });

                // Add filters
                const itemName = document.getElementById('order-item')?.value;
                const marketName = document.getElementById('order-market')?.value;
                const orderType = document.getElementById('order-type')?.value;

                if (itemName) params.append('itemName', itemName);
                if (marketName) params.append('marketName', marketName);
                if (orderType) {
                    params.append('orderType', orderType);
                }

                const response = await fetch(getApiUrl(`/orders?${params}`));
                const result = await response.json();

                if (response.ok && result.data && Array.isArray(result.data)) {
                    currentData.orders = {
                        data: result.data,
                        page: result.page,
                        totalPages: result.totalPages,
                        sortBy: currentData.orders.sortBy,
                        sortOrder: currentData.orders.sortOrder
                    };
                    renderOrdersTable();
                    renderPagination('orders', result);
                } else {
                    console.error('Orders API response:', result);
                    tableBody.innerHTML = `<tr><td colspan="6" class="error">Error loading orders</td></tr>`;
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                tableBody.innerHTML = '<tr><td colspan="6" class="error">Network error loading orders</td></tr>';
            }
        }

        function renderOrdersTable() {
            const tableBody = document.getElementById('orders-table-body');

            if (currentData.orders.data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="empty-state">No orders found</td></tr>';
                return;
            }

            tableBody.innerHTML = currentData.orders.data.map(order => `
                <tr>
                    <td><strong>${escapeHtml(order.itemName)}</strong></td>
                    <td>
                        <span class="${order.buyQuantity > 0 ? 'text-success' : 'text-danger'}">
                            ${order.buyQuantity > 0 ? 'BUY' : 'SELL'}
                        </span>
                    </td>
                    <td>${formatNumber(order.buyQuantity > 0 ? order.buyQuantity : order.sellQuantity)}</td>
                    <td>${formatCurrency(order.unitPrice)}</td>
                    <td>${escapeHtml(order.marketName)}<br><small class="text-muted">${escapeHtml(order.planetName)}</small></td>
                    <td>${escapeHtml(order.playerName)}</td>
                </tr>
            `).join('');
        }

        function sortOrders(column) {
            if (currentData.orders.sortBy === column) {
                currentData.orders.sortOrder = currentData.orders.sortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                currentData.orders.sortBy = column;
                currentData.orders.sortOrder = column === 'unitPrice' ? 'desc' : 'asc';
            }

            updateSortHeaders('orders', column, currentData.orders.sortOrder);
            loadOrders(currentData.orders.page);
        }

        function searchOrders() {
            loadOrders(1);
        }

        function clearOrderFilters() {
            document.getElementById('order-item').value = '';
            document.getElementById('order-market').value = '';
            document.getElementById('order-type').value = '';
            searchOrders();
        }

        // Profit Opportunities Management
        let currentProfitTab = 'opportunities';

        function showProfitTab(tabName) {
            // Update tab navigation
            document.querySelectorAll('#profits-panel .nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[onclick="showProfitTab('${tabName}')"]`).classList.add('active');

            // Update content visibility
            document.querySelectorAll('.profit-content').forEach(content => content.style.display = 'none');
            document.getElementById(`${tabName}-content`).style.display = 'block';

            currentProfitTab = tabName;
        }

        async function loadProfits(page = 1) {
            const container = document.getElementById('profits-container');
            container.innerHTML = '<div class="loading">Loading profit opportunities...</div>';

            try {
                const params = new URLSearchParams({
                    page: page,
                    pageSize: 10,
                    sortBy: currentData.profits.sortBy,
                    sortOrder: currentData.profits.sortOrder
                });

                // Add basic filters
                const itemName = document.getElementById('profit-item')?.value;
                const minMargin = document.getElementById('profit-min-margin')?.value;

                if (itemName) params.append('itemName', itemName);
                if (minMargin) params.append('minProfitMargin', parseFloat(minMargin) / 100);

                // Add route optimization filters
                const destinationMarket = document.getElementById('destination-market')?.value;
                const maxDistanceBase = document.getElementById('max-distance-base')?.value;
                const maxDistanceDest = document.getElementById('max-distance-dest')?.value;
                const routeOptimization = document.getElementById('route-optimization')?.value === 'true';

                if (destinationMarket) params.append('destinationMarketId', destinationMarket);
                if (maxDistanceBase) params.append('maxDistanceFromBase', parseFloat(maxDistanceBase) * 200000); // Convert SU to m (1 SU = 200km = 200,000m)
                if (maxDistanceDest) params.append('maxDistanceToDestination', parseFloat(maxDistanceDest) * 200000);
                if (routeOptimization) params.append('routeOptimization', 'true');

                // Use route-based endpoint if route optimization is enabled
                const endpoint = routeOptimization ? '/profits/route' : '/profits';
                const response = await fetch(getApiUrl(`${endpoint}?${params}`));
                const result = await response.json();

                if (response.ok && result.data && Array.isArray(result.data)) {
                    currentData.profits = {
                        data: result.data,
                        page: result.page,
                        totalPages: result.totalPages,
                        sortBy: currentData.profits.sortBy,
                        sortOrder: currentData.profits.sortOrder
                    };
                    renderProfitsCards();
                    renderPagination('profits', result);
                } else {
                    console.error('Profits API response:', result);
                    container.innerHTML = `<div class="error">Error loading profit opportunities</div>`;
                }
            } catch (error) {
                console.error('Error loading profits:', error);
                container.innerHTML = '<div class="error">Network error loading profit opportunities</div>';
            }
        }

        function renderProfitsCards() {
            const container = document.getElementById('profits-container');

            if (currentData.profits.data.length === 0) {
                container.innerHTML = '<div class="empty-state">No profit opportunities found</div>';
                return;
            }

            container.innerHTML = currentData.profits.data.map(profit => `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">${escapeHtml(profit.itemName)}</h3>
                        <div class="text-success font-weight-bold">
                            ${formatCurrency({ amount: profit.profitPerUnit })} per unit
                        </div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 15px; border-radius: 8px;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold;">${formatCurrency({ amount: profit.totalProfit })}</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Total Profit</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold;">${(profit.profitMargin).toFixed(1)}%</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Margin</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold;">${formatNumber(profit.maxQuantity)}</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Max Quantity</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold;">${profit.distanceFormatted || formatDistance(profit.distance)}</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Distance</div>
                            </div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h4 class="text-success">üõí Buy From (Low Price)</h4>
                            <p><strong>Market:</strong> ${escapeHtml(profit.sellOrder.marketName)}</p>
                            <p><strong>Planet:</strong> ${escapeHtml(profit.sellOrder.planetName)}</p>
                            <p><strong>Price:</strong> ${formatCurrency(profit.sellOrder.unitPrice)}</p>
                            <p><strong>Quantity:</strong> ${formatNumber(profit.sellOrder.quantity)}</p>
                            <p><strong>Player:</strong> ${escapeHtml(profit.sellOrder.playerName)}</p>
                        </div>
                        <div>
                            <h4 class="text-danger">üí∞ Sell To (High Price)</h4>
                            <p><strong>Market:</strong> ${escapeHtml(profit.buyOrder.marketName)}</p>
                            <p><strong>Planet:</strong> ${escapeHtml(profit.buyOrder.planetName)}</p>
                            <p><strong>Price:</strong> ${formatCurrency(profit.buyOrder.unitPrice)}</p>
                            <p><strong>Quantity:</strong> ${formatNumber(profit.buyOrder.quantity)}</p>
                            <p><strong>Player:</strong> ${escapeHtml(profit.buyOrder.playerName)}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function searchProfits() {
            loadProfits(1);
        }

        function clearProfitFilters() {
            document.getElementById('profit-item').value = '';
            document.getElementById('profit-min-margin').value = '';
            document.getElementById('destination-market').value = '';
            document.getElementById('max-distance-base').value = '';
            document.getElementById('max-distance-dest').value = '';
            document.getElementById('route-optimization').value = 'false';
            searchProfits();
        }

        // Generate Optimized Routes
        async function generateOptimizedRoutes() {
            const container = document.getElementById('routes-container');
            container.innerHTML = '<div class="loading">Generating optimized trading routes...</div>';

            // Switch to routes tab
            showProfitTab('routes');

            try {
                const params = new URLSearchParams({
                    maxRoutes: 5,
                    maxStops: 3
                });

                // Add filters
                const itemName = document.getElementById('profit-item')?.value;
                const minMargin = document.getElementById('profit-min-margin')?.value;
                const destinationMarket = document.getElementById('destination-market')?.value;
                const maxDistanceBase = document.getElementById('max-distance-base')?.value;
                const maxDistanceDest = document.getElementById('max-distance-dest')?.value;

                if (itemName) params.append('itemName', itemName);
                if (minMargin) params.append('minProfitMargin', parseFloat(minMargin) / 100);
                if (destinationMarket) params.append('destinationMarketId', destinationMarket);
                if (maxDistanceBase) params.append('maxDistanceFromBase', parseFloat(maxDistanceBase) * 200000);
                if (maxDistanceDest) params.append('maxDistanceToDestination', parseFloat(maxDistanceDest) * 200000);

                const response = await fetch(getApiUrl(`/profits/routes/optimized?${params}`));
                const result = await response.json();

                if (response.ok && result.routes && Array.isArray(result.routes)) {
                    renderOptimizedRoutes(result.routes);
                } else {
                    console.error('Routes API response:', result);
                    container.innerHTML = `<div class="error">Error generating optimized routes</div>`;
                }
            } catch (error) {
                console.error('Error generating routes:', error);
                container.innerHTML = '<div class="error">Network error generating routes</div>';
            }
        }

        function renderOptimizedRoutes(routes) {
            const container = document.getElementById('routes-container');

            if (routes.length === 0) {
                container.innerHTML = '<div class="empty-state">No optimized routes found with current filters</div>';
                return;
            }

            container.innerHTML = routes.map((route, index) => `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üó∫Ô∏è Route ${index + 1}</h3>
                        <div class="text-success font-weight-bold">
                            ${formatCurrency({ amount: route.totalProfit })} total profit
                        </div>
                    </div>
                    
                    <!-- Route Summary -->
                    <div style="margin-bottom: 15px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; background: linear-gradient(135deg, #6f42c1, #e83e8c); color: white; padding: 15px; border-radius: 8px;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold;">${route.stopCount}</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Stops</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold;">${route.totalDistanceFormatted}</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Total Distance</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold;">${formatCurrency({ amount: route.totalProfit })}</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Total Profit</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold;">${route.profitPerKm.toFixed(1)}</div>
                                <div style="font-size: 0.9rem; opacity: 0.9;">Profit/km</div>
                            </div>
                        </div>
                    </div>

                    <!-- Route Markets -->
                    <div style="margin-bottom: 15px;">
                        <h4>üìç Route Markets</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                            ${route.markets.map((market, marketIndex) => `
                                <div style="background: #f8f9fa; padding: 8px 12px; border-radius: 6px; border-left: 4px solid #1e3c72;">
                                    <strong>${escapeHtml(market.name)}</strong><br>
                                    <small class="text-muted">${escapeHtml(market.planetName)}</small>
                                </div>
                                ${marketIndex < route.markets.length - 1 ? '<div style="color: #1e3c72; font-weight: bold;">‚Üí</div>' : ''}
                            `).join('')}
                        </div>
                    </div>

                    <!-- Route Opportunities -->
                    <div>
                        <h4>üí∞ Trading Opportunities</h4>
                        <div style="display: grid; gap: 10px;">
                            ${route.opportunities.map(opportunity => `
                                <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; border-left: 4px solid #28a745;">
                                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 15px; align-items: center;">
                                        <div>
                                            <strong>${escapeHtml(opportunity.itemName)}</strong><br>
                                            <small class="text-muted">${formatNumber(opportunity.maxQuantity)} units available</small>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-success"><strong>Buy From</strong></div>
                                            <div>${escapeHtml(opportunity.sellOrder.marketName)}</div>
                                            <div class="text-muted">${formatCurrency(opportunity.sellOrder.unitPrice)}</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-danger"><strong>Sell To</strong></div>
                                            <div>${escapeHtml(opportunity.buyOrder.marketName)}</div>
                                            <div class="text-muted">${formatCurrency(opportunity.buyOrder.unitPrice)}</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-success font-weight-bold">${formatCurrency({ amount: opportunity.totalProfit })}</div>
                                            <div class="text-muted">${(opportunity.profitMargin).toFixed(1)}% margin</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Planets Management
        async function loadPlanets() {
            const tableBody = document.getElementById('planets-table-body');
            tableBody.innerHTML = '<tr><td colspan="4" class="loading">Loading planets...</td></tr>';

            try {
                const response = await fetch(getApiUrl('/planets'));
                const result = await response.json();

                // Handle both array response and object with data property
                const planets = Array.isArray(result) ? result : (result.data || []);

                if (response.ok && Array.isArray(planets)) {
                    currentData.planets.data = planets;
                    renderPlanetsTable();

                    // Populate planet filter dropdown
                    const planetSelect = document.getElementById('market-planet');
                    if (planetSelect) {
                        planetSelect.innerHTML = '<option value="">All Planets</option>' +
                            planets.map(planet => `<option value="${escapeHtml(planet.name)}">${escapeHtml(planet.name)}</option>`).join('');
                    }

                    // Also populate market dropdowns
                    await populateMarketDropdowns();
                } else {
                    console.error('Planets API response:', result);
                    tableBody.innerHTML = `<tr><td colspan="4" class="error">Error loading planets</td></tr>`;
                }
            } catch (error) {
                console.error('Error loading planets:', error);
                tableBody.innerHTML = '<tr><td colspan="4" class="error">Network error loading planets</td></tr>';
            }
        }

        // Populate market dropdowns with ALL market data
        async function populateMarketDropdowns() {
            try {
                // Fetch all markets for dropdowns (not just current page)
                const response = await fetch(getApiUrl('/markets?pageSize=1000'));
                const result = await response.json();
                const allMarkets = result.data || [];

                // Populate order market filter dropdown
                const orderMarketSelect = document.getElementById('order-market');
                if (orderMarketSelect) {
                    orderMarketSelect.innerHTML = '<option value="">All Markets</option>' +
                        allMarkets.map(market => `<option value="${escapeHtml(market.name)}">${escapeHtml(market.name)} (${escapeHtml(market.planetName)})</option>`).join('');
                }

                // Populate destination market dropdown for profit opportunities
                const destinationSelect = document.getElementById('destination-market');
                if (destinationSelect) {
                    destinationSelect.innerHTML = '<option value="">Any destination market</option>' +
                        allMarkets.map(market => `<option value="${market.marketId}">${escapeHtml(market.name)} (${escapeHtml(market.planetName)})</option>`).join('');
                }

                console.log(`Populated market dropdowns with ${allMarkets.length} markets`);
            } catch (error) {
                console.error('Error populating market dropdowns:', error);
            }
        }

        function renderPlanetsTable() {
            const tableBody = document.getElementById('planets-table-body');

            if (currentData.planets.data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="empty-state">No planets found</td></tr>';
                return;
            }

            tableBody.innerHTML = currentData.planets.data.map(planet => `
                <tr>
                    <td><strong>${escapeHtml(planet.name)}</strong></td>
                    <td>${planet.marketCount || 0}</td>
                    <td>${formatDistance(planet.distanceFromOrigin)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="filterByPlanet('${escapeHtml(planet.name)}')">
                            View Markets
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function sortPlanets(column) {
            renderPlanetsTable();
        }

        function filterByPlanet(planetName) {
            showTab('markets');
            // Wait for tab to load, then set filter
            setTimeout(() => {
                const planetSelect = document.getElementById('market-planet');
                if (planetSelect) {
                    planetSelect.value = planetName;
                    searchMarkets();
                }
            }, 100);
        }

        // Statistics Management
        async function loadStatistics() {
            const container = document.getElementById('statistics-container');
            container.innerHTML = '<div class="loading">Loading statistics...</div>';

            try {
                const response = await fetch(getApiUrl('/stats'));
                const stats = await response.json();

                if (response.ok) {
                    renderStatistics(stats);
                } else {
                    container.innerHTML = `<div class="error">Error loading statistics</div>`;
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
                container.innerHTML = '<div class="error">Network error loading statistics</div>';
            }
        }

        function renderStatistics(stats) {
            const container = document.getElementById('statistics-container');

            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Market Statistics</h3>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div class="text-center">
                            <div style="font-size: 2rem; font-weight: bold; color: #1e3c72;">${stats.markets?.total || 0}</div>
                            <div>Total Markets</div>
                        </div>
                        <div class="text-center">
                            <div style="font-size: 2rem; font-weight: bold; color: #28a745;">${stats.markets?.withOrders || 0}</div>
                            <div>Markets with Orders</div>
                        </div>
                        <div class="text-center">
                            <div style="font-size: 2rem; font-weight: bold; color: #ffc107;">${stats.markets?.averageOrdersPerMarket?.toFixed(1) || 0}</div>
                            <div>Avg Orders per Market</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Order Statistics</h3>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div class="text-center">
                            <div style="font-size: 2rem; font-weight: bold; color: #1e3c72;">${stats.orders?.total || 0}</div>
                            <div>Total Orders</div>
                        </div>
                        <div class="text-center">
                            <div style="font-size: 2rem; font-weight: bold; color: #28a745;">${stats.orders?.buyOrders || 0}</div>
                            <div>Buy Orders</div>
                        </div>
                        <div class="text-center">
                            <div style="font-size: 2rem; font-weight: bold; color: #dc3545;">${stats.orders?.sellOrders || 0}</div>
                            <div>Sell Orders</div>
                        </div>
                        <div class="text-center">
                            <div style="font-size: 2rem; font-weight: bold; color: #6f42c1;">${stats.orders?.uniqueItems || 0}</div>
                            <div>Unique Items</div>
                        </div>
                        <div class="text-center">
                            <div style="font-size: 2rem; font-weight: bold; color: #fd7e14;">${stats.orders?.uniquePlayers || 0}</div>
                            <div>Unique Players</div>
                        </div>
                        <div class="text-center">
                            <div style="font-size: 2rem; font-weight: bold; color: #20c997;">${formatNumber(stats.orders?.totalVolume || 0)}</div>
                            <div>Total Volume</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Markets by Planet</h3>
                    </div>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Planet</th>
                                    <th>Market Count</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(stats.markets?.byPlanet || {}).map(([planet, count]) => `
                                <tr>
                                    <td>${escapeHtml(planet)}</td>
                                    <td>${count}</td>
                                </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Cache Information</h3>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div class="text-center">
                            <div style="font-size: 1.5rem; font-weight: bold; color: ${stats.cache?.isStale ? '#dc3545' : '#28a745'};">
                                ${stats.cache?.isStale ? 'Stale' : 'Fresh'}
                            </div>
                            <div>Cache Status</div>
                        </div>
                        <div class="text-center">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #1e3c72;">${Math.floor(stats.cache?.age || 0)}m</div>
                            <div>Cache Age</div>
                        </div>
                        <div class="text-center">
                            <div style="font-size: 1.5rem; font-weight: bold; color: ${stats.cache?.consecutiveFailures > 0 ? '#dc3545' : '#28a745'};">
                                ${stats.cache?.consecutiveFailures || 0}
                            </div>
                            <div>Consecutive Failures</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Utility Functions
        function formatCurrency(currencyOrNumber) {
            // Handle both Currency objects (for backward compatibility) and plain numbers (new format)
            let amount;
            if (typeof currencyOrNumber === 'number') {
                amount = currencyOrNumber;
            } else if (currencyOrNumber && typeof currencyOrNumber.amount === 'number') {
                amount = currencyOrNumber.amount;
            } else {
                return 'N/A';
            }
            
            // Format as currency (prices are now in decimal format, already divided by 100)
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount).replace('$', '');
        }

        function formatNumber(num) {
            if (typeof num !== 'number') return 'N/A';
            return new Intl.NumberFormat('en-US').format(num);
        }

        function formatDistance(distance) {
            if (typeof distance !== 'number') return 'N/A';
            if (distance < 1000) return `${distance.toFixed(0)}m`;
            if (distance < 1000000) return `${(distance / 1000).toFixed(1)}km`;
            return `${(distance / 1000000).toFixed(1)}Mm`;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 1000;
                max-width: 400px;
                box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;

            switch (type) {
                case 'success': notification.style.background = '#28a745'; break;
                case 'error': notification.style.background = '#dc3545'; break;
                case 'warning': notification.style.background = '#ffc107'; break;
                default: notification.style.background = '#1e3c72'; break;
            }

            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);

            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }

        // Utility Functions
        function renderPagination(type, result) {
            const paginationContainer = document.getElementById(`${type}-pagination`);

            if (!paginationContainer) return;

            if (result.totalPages <= 1) {
                paginationContainer.innerHTML = '';
                return;
            }

            const currentPage = result.page;
            const totalPages = result.totalPages;

            let paginationHTML = `
                <div class="pagination-info">
                    Showing ${((currentPage - 1) * result.pageSize) + 1}-${Math.min(currentPage * result.pageSize, result.totalCount)}
                    of ${result.totalCount} items
                </div>
                <div class="pagination-controls">
            `;

            // Previous button
            paginationHTML += `
                <button class="page-btn" ${currentPage === 1 ? 'disabled' : ''} 
                    onclick="changePage('${type}', ${currentPage - 1})">
                    ‚Äπ Previous
                </button>
            `;

            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) {
                paginationHTML += `<button class="page-btn" onclick="changePage('${type}', 1)">1</button>`;
                if (startPage > 2) {
                    paginationHTML += `<span>...</span>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <button class="page-btn ${i === currentPage ? 'active' : ''}" 
                        onclick="changePage('${type}', ${i})">
                        ${i}
                    </button>
                `;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<span>...</span>`;
                }
                paginationHTML += `<button class="page-btn" onclick="changePage('${type}', ${totalPages})">${totalPages}</button>`;
            }

            // Next button
            paginationHTML += `
                <button class="page-btn" ${currentPage === totalPages ? 'disabled' : ''} 
                    onclick="changePage('${type}', ${currentPage + 1})">
                    Next ‚Ä∫
                </button>
            `;

            paginationHTML += '</div>';
            paginationContainer.innerHTML = paginationHTML;
        }

        function changePage(type, page) {
            switch (type) {
                case 'markets':
                    currentData.markets.page = page;
                    loadMarkets(page);
                    break;
                case 'orders':
                    currentData.orders.page = page;
                    loadOrders(page);
                    break;
                case 'profits':
                    currentData.profits.page = page;
                    loadProfits(page);
                    break;
            }
        }

        function updateSortHeaders(tableType, column, order) {
            const table = document.querySelector(`#${tableType}-panel .data-table`);
            if (!table) return;

            // Reset all headers
            table.querySelectorAll('th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });

            // Find and update the sorted column header
            const headers = table.querySelectorAll('th');
            headers.forEach(th => {
                const onclick = th.getAttribute('onclick');
                if (onclick && onclick.includes(`'${column}'`)) {
                    th.classList.add(order === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });
        }

        // Load version information
        async function loadVersionInfo() {
            try {
                const response = await fetch(getApiUrl('/version'));
                const versionData = await response.json();

                if (response.ok && versionData) {
                    const versionElement = document.getElementById('version-info');
                    if (versionElement) {
                        versionElement.textContent = `Version ${versionData.version} - ${versionData.description}`;
                    }
                }
            } catch (error) {
                console.debug('Could not load version information:', error);
                // Fail silently - version info is not critical
            }
        }

        // Auto-refresh every 5 minutes
        setInterval(loadSystemStatus, 5 * 60 * 1000);

        // Load version info on page load
        loadVersionInfo();
    </script>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h4>MyDU Market Browser</h4>
                <p id="version-info">Version 1.0.0 - Advanced market analysis for Dual Universe</p>
                <p>Built with ‚ù§Ô∏è for the MyDU community</p>
            </div>
            <div class="footer-section">
                <h4>Features</h4>
                <ul>
                    <li>Real-time market data</li>
                    <li>Profit opportunity analysis</li>
                    <li>Route optimization</li>
                    <li>Distance calculations</li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>Developed by</h4>
                <p>
                    <a href="https://karich.design/" target="_blank" rel="noopener noreferrer" class="company-link">
                        <strong>karich.design</strong>
                    </a>
                </p>
                <p class="footer-tagline">Professional web development & design solutions</p>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 karich.design. This tool is provided as-is for the MyDU community. Open source soon!</p>
        </div>
    </footer>
</body>

</html>